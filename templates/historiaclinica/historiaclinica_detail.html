{% extends 'base/base.html' %}

{% block title %}Historia Clínica - Fisioterapia Clinic{% endblock %}

{% block page_title %}Historia Clínica{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <div class="row g-0">
        <div class="col-lg-10 offset-lg-1">
            <!-- Información del Paciente -->
            <div class="card border-0 shadow-sm mb-3 mx-2 mx-lg-0">
                <div class="card-header bg-light p-2 p-md-3">
                    <div class="d-flex justify-content-between align-items-start flex-column flex-sm-row gap-2">
                        <div class="flex-grow-1">
                            <h6 class="mb-1"><i class="fas fa-file-medical"></i> {{ historia.paciente.nombre_completo }}</h6>
                            <small class="text-muted d-block">Fecha: {{ historia.fecha_evaluacion|date:"d/m/Y H:i" }}</small>
                            <small class="text-muted">EVA: {{ historia.escala_eva|default:"-" }}</small>
                        </div>
                        <span class="badge {% if historia.activo %}bg-success{% else %}bg-secondary{% endif %}">
                            {% if historia.activo %}Activa{% else %}Cerrada{% endif %}
                        </span>
                    </div>
                </div>
                <div class="card-body p-2 p-md-3">
                    <h6 class="mb-2 border-bottom pb-2"><i class="fas fa-stethoscope"></i> Diagnóstico</h6>
                    <p class="mb-3 small">{{ historia.diagnostico|linebreaks }}</p>

                    <h6 class="mb-2 border-bottom pb-2"><i class="fas fa-clipboard-check"></i> Pronóstico</h6>
                    <p class="mb-3 small">{{ historia.pronostico|default:"-"|linebreaks }}</p>

                    <h6 class="mb-2 border-bottom pb-2"><i class="fas fa-hand-holding-medical"></i> Tratamiento Planificado</h6>
                    <p class="mb-3 small">{{ historia.tratamiento_planificado|linebreaks }}</p>

                    <h6 class="mb-2 border-bottom pb-2"><i class="fas fa-notes-medical"></i> Notas de Arcos de Movimiento</h6>
                    <p class="mb-0 small">{{ historia.notas_arcos_movimiento|default:"-"|linebreaks }}</p>
                </div>
                <div class="card-footer bg-light p-2 d-flex justify-content-between gap-2">
                    <a href="{% url 'historiaclinica:lista' %}" class="btn btn-secondary btn-sm"><i class="fas fa-arrow-left"></i> Volver</a>
                    <a href="{% url 'historiaclinica:editar' historia.pk %}" class="btn btn-primary btn-sm"><i class="fas fa-edit"></i> Editar</a>
                </div>
            </div>

            <!-- Estudios Clínicos -->
            <div class="card border-0 shadow-sm mb-3 mx-2 mx-lg-0">
                <div class="card-header bg-light p-2">
                    <div class="d-flex justify-content-between align-items-center flex-column flex-sm-row gap-2">
                        <h6 class="mb-0"><i class="fas fa-x-ray"></i> Estudios clínicos</h6>
                        <div class="d-flex gap-2 w-100 w-sm-auto">
                            <a href="{% url 'historiaclinica:estudios' historia.pk %}" class="btn btn-outline-secondary btn-sm flex-grow-1 flex-sm-grow-0">
                                <i class="fas fa-list"></i> <span class="d-none d-md-inline">Ver todos</span>
                            </a>
                            <a href="{% url 'historiaclinica:estudio-crear' historia.pk %}" class="btn btn-sm btn-success flex-grow-1 flex-sm-grow-0">
                                <i class="fas fa-plus"></i> <span class="d-none d-md-inline">Registrar</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabla de Estudios -->
<div class="tabla-estudios-wrapper">
    <div class="card border-0 shadow-sm tabla-estudios-card mb-3">
        <div class="card-body p-0">
            {% if estudios %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Tipo</th>
                                <th>Fecha</th>
                                <th>Descripción</th>
                                <th class="text-end">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for es in estudios|slice:':5' %}
                                <tr>
                                    <td>{{ es.get_tipo_display }}</td>
                                    <td>{{ es.fecha_estudio|date:"d/m/Y" }}</td>
                                    <td>{{ es.descripcion|default:"-"|truncatechars:80 }}</td>
                                    <td class="text-end">
                                        <a href="{% url 'historiaclinica:estudio-editar' es.pk %}" class="btn btn-sm btn-primary" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'historiaclinica:estudio-eliminar' es.pk %}" class="btn btn-sm btn-danger" title="Eliminar" onclick="return confirm('¿Está seguro de eliminar este estudio?')">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="px-3 py-2 text-muted small">Mostrando últimos 5 estudios.</div>
            {% else %}
                <div class="p-3 text-muted small">No hay estudios registrados.</div>
            {% endif %}
        </div>
    </div>
</div>

<div class="container-fluid p-0">
    <div class="row g-0">
        <div class="col-lg-10 offset-lg-1">
            <!-- Escala Daniels -->
            <div class="card border-0 shadow-sm mb-3 mx-2 mx-lg-0">
                <div class="card-header bg-light p-2">
                    <div class="d-flex justify-content-between align-items-center flex-column flex-sm-row gap-2">
                        <h6 class="mb-0"><i class="fas fa-hand-rock"></i> Escala Daniels (Fuerza Muscular)</h6>
                        <div class="d-flex gap-2 w-100 w-sm-auto">
                            <a href="{% url 'historiaclinica:daniels-lista' historia.pk %}" class="btn btn-outline-secondary btn-sm flex-grow-1 flex-sm-grow-0">
                                <i class="fas fa-list"></i> <span class="d-none d-md-inline">Ver todas</span>
                            </a>
                            <a href="{% url 'historiaclinica:daniels-crear' historia.pk %}" class="btn btn-sm btn-success flex-grow-1 flex-sm-grow-0">
                                <i class="fas fa-plus"></i> <span class="d-none d-md-inline">Nueva</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabla Daniels -->
<div class="tabla-daniels-wrapper">
    <div class="card border-0 shadow-sm tabla-daniels-card mb-3">
        <div class="card-body p-0">
            {% if evaluaciones_daniels %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Músculo</th>
                                <th>Grado</th>
                                <th>Descripción</th>
                                <th class="text-end">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for eval in evaluaciones_daniels|slice:':5' %}
                                <tr>
                                    <td><strong>{{ eval.musculo }}</strong></td>
                                    <td>
                                        <span class="badge 
                                            {% if eval.grado == '0' %}bg-danger
                                            {% elif eval.grado == '1' %}bg-warning
                                            {% elif eval.grado == '2' %}bg-info
                                            {% elif eval.grado == '3' %}bg-primary
                                            {% elif eval.grado == '4' %}bg-success
                                            {% else %}bg-dark
                                            {% endif %}">
                                            {{ eval.grado }}
                                        </span>
                                    </td>
                                    <td>{{ eval.get_grado_display }}</td>
                                    <td class="text-end">
                                        <a href="{% url 'historiaclinica:daniels-editar' eval.pk %}" class="btn btn-sm btn-primary" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'historiaclinica:daniels-eliminar' eval.pk %}" class="btn btn-sm btn-danger" title="Eliminar" onclick="return confirm('¿Está seguro de eliminar esta evaluación?')">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="px-3 py-2 text-muted small">Mostrando últimas 5 evaluaciones.</div>
            {% else %}
                <div class="p-3 text-muted small">No hay evaluaciones musculares registradas.</div>
            {% endif %}
        </div>
    </div>
</div>

<div class="container-fluid p-0">
    <div class="row g-0">
        <div class="col-lg-10 offset-lg-1">
            <!-- Ejercicios -->
            <div class="card border-0 shadow-sm mb-3 mx-2 mx-lg-0">
                <div class="card-header bg-light p-2">
                    <div class="d-flex justify-content-between align-items-center flex-column flex-sm-row gap-2">
                        <h6 class="mb-0"><i class="fas fa-dumbbell"></i> Ejercicios Terapéuticos</h6>
                        <div class="d-flex gap-2 w-100 w-sm-auto">
                            <a href="{% url 'historiaclinica:ejercicios-pdf' historia.pk %}" class="btn btn-sm btn-outline-danger flex-grow-1 flex-sm-grow-0" target="_blank">
                                <i class="fas fa-file-pdf"></i> PDF
                            </a>
                            <a href="{% url 'historiaclinica:ejercio-crear' historia.pk %}" class="btn btn-sm btn-success flex-grow-1 flex-sm-grow-0">
                                <i class="fas fa-plus"></i> <span class="d-none d-md-inline">Agregar</span>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if ejercicios %}
                        <ul class="list-group list-group-flush">
                            {% for e in ejercicios %}
                                <li class="list-group-item p-2">
                                    <div class="d-flex justify-content-between align-items-start flex-column flex-sm-row gap-2">
                                        <div class="flex-grow-1">
                                            <strong class="small">{{ e.nombre_ejercicio }}</strong><br>
                                            <small class="text-muted">Series: {{ e.series }} | Reps: {{ e.repeticiones }} | Frec: {{ e.frecuencia }}</small>
                                            {% if e.notas %}<div class="text-muted mt-2 small">{{ e.notas }}</div>{% endif %}
                                        </div>
                                        <div class="d-flex gap-2 align-items-center">
                                            <span class="badge {% if e.es_ejercicio_casa %}bg-info{% else %}bg-secondary{% endif %} small">
                                                {% if e.es_ejercicio_casa %}Casa{% else %}Clínica{% endif %}
                                            </span>
                                            <a href="{% url 'historiaclinica:ejercio-editar' e.pk %}" class="btn btn-sm btn-primary" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="{% url 'historiaclinica:ejercio-eliminar' e.pk %}" class="btn btn-sm btn-danger" title="Eliminar" onclick="return confirm('¿Está seguro de eliminar este ejercicio?')">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="p-3 text-muted small">No hay ejercicios registrados.</div>
                    {% endif %}
                </div>
            </div>

            <!-- Evoluciones Header -->
            <div class="card border-0 shadow-sm mb-3 mx-2 mx-lg-0">
                <div class="card-header bg-light p-2">
                    <div class="d-flex justify-content-between align-items-center flex-column flex-sm-row gap-2">
                        <h6 class="mb-0"><i class="fas fa-notes-medical"></i> Evoluciones</h6>
                        <a href="{% url 'historiaclinica:evolucion-crear' historia.pk %}" class="btn btn-sm btn-success w-100 w-sm-auto">
                            <i class="fas fa-plus"></i> Registrar sesión
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabla Evoluciones -->
<div class="tabla-evoluciones-wrapper">
    <div class="card border-0 shadow-sm tabla-evoluciones-card mb-3">
        <div class="card-body p-0">
            {% if evoluciones %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Fecha</th>
                                <th>Sesión</th>
                                <th>EVA</th>
                                <th>Notas</th>
                                <th class="text-end">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ev in evoluciones %}
                                <tr>
                                    <td>{{ ev.fecha_sesion|date:"d/m/Y" }}</td>
                                    <td>{{ ev.numero_sesion }}</td>
                                    <td>{{ ev.escala_eva_sesion|default:"-" }}</td>
                                    <td>{{ ev.notas_sesion|truncatechars:80 }}</td>
                                    <td class="text-end">
                                        <a href="{% url 'historiaclinica:evolucion-editar' ev.pk %}" class="btn btn-sm btn-primary" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'historiaclinica:evolucion-eliminar' ev.pk %}" class="btn btn-sm btn-danger" title="Eliminar" onclick="return confirm('¿Está seguro de eliminar esta evolución?')">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="p-3 text-muted small">No hay sesiones registradas.</div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    /* Wrappers de tablas sin restricciones */
    .tabla-estudios-wrapper,
    .tabla-daniels-wrapper,
    .tabla-evoluciones-wrapper {
        width: 100vw;
        position: relative;
        left: 50%;
        right: 50%;
        margin-left: -50vw;
        margin-right: -50vw;
    }
    
    /* En desktop, restaurar el ancho normal */
    @media (min-width: 992px) {
        .tabla-estudios-wrapper,
        .tabla-daniels-wrapper,
        .tabla-evoluciones-wrapper {
            width: auto;
            position: static;
            left: auto;
            right: auto;
            margin-left: auto;
            margin-right: auto;
        }
        
        .tabla-estudios-wrapper .tabla-estudios-card,
        .tabla-daniels-wrapper .tabla-daniels-card,
        .tabla-evoluciones-wrapper .tabla-evoluciones-card {
            max-width: 100%;
            margin: 0 auto 1rem auto !important;
        }
    }
    
    /* Optimización móvil */
    @media (max-width: 767px) {
        body {
            font-size: 0.875rem;
            overflow-x: hidden;
        }
        
        .container-fluid {
            padding: 0 !important;
        }
        
        .card {
            font-size: 0.85rem;
        }
        
        /* Tablas ocupan todo el ancho solo en móvil */
        .tabla-estudios-card,
        .tabla-daniels-card,
        .tabla-evoluciones-card {
            margin: 0 !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            width: 100% !important;
        }
        
        .tabla-estudios-card .card-body,
        .tabla-daniels-card .card-body,
        .tabla-evoluciones-card .card-body {
            padding: 0 !important;
        }
        
        .table {
            font-size: 0.75rem;
        }
        
        .table td, .table th {
            padding: 0.4rem 0.3rem;
            white-space: nowrap;
        }
        
        .btn-sm {
            padding: 0.2rem 0.4rem;
            font-size: 0.7rem;
        }
        
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .fas, .far {
            font-size: 0.75rem;
        }
        
        h6 {
            font-size: 0.875rem;
        }
        
        .badge {
            font-size: 0.65rem;
            padding: 0.2em 0.4em;
        }
        
        .list-group-item {
            font-size: 0.85rem;
        }
    }
    
    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    /* Mejorar espaciado en móvil */
    @media (max-width: 575px) {
        .card-body {
            padding: 0.75rem;
        }
        
        .mb-3 {
            margin-bottom: 0.75rem !important;
        }
        
        .gap-2 {
            gap: 0.5rem !important;
        }
    }
</style>
{% endblock %}