{% extends 'base/base.html' %}

{% block title %}Antecedentes Patológicos{% endblock %}
{% block page_title %}Antecedentes Patológicos{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <div class="card border-0 shadow-sm mb-3 mx-2 mx-md-3">
        <div class="card-header bg-light p-2 p-md-3">
            <div class="mb-2">
                <h6 class="mb-1"><i class="fas fa-notes-medical"></i> Gestionar antecedentes patológicos</h6>
                <small class="text-muted">Selecciona un paciente para registrar o actualizar sus antecedentes patológicos.</small>
            </div>
            <form id="antecedentsFilterForm" method="get" class="d-flex gap-2">
                <input type="text" name="busqueda" value="{{ busqueda }}" class="form-control form-control-sm" placeholder="Buscar paciente...">
            </form>
        </div>
    </div>
</div>

<!-- Tabla FUERA del container-fluid -->
<div class="tabla-antecedentes-wrapper">
    <div class="card border-0 shadow-sm tabla-antecedentes-card">
        <div class="card-body p-0" id="tablaAntecedentes">
            {% include 'pacientes/partials/_antecedentes_pat_table.html' %}
        </div>
        <div id="paginacionAntecedentes">
            {% include 'pacientes/partials/_antecedentes_pat_pagination.html' %}
        </div>
    </div>
</div>

<style>
    
    
    /* Optimización móvil */
    @media (max-width: 767px) {
        body {
            font-size: 0.875rem;
            overflow-x: hidden;
        }
        /* Wrapper de tabla sin restricciones */
    .tabla-antecedentes-wrapper {
        width: 100vw;
        position: relative;
        left: 50%;
        right: 50%;
        margin-left: -50vw;
        margin-right: -50vw;
    }
        
        /* Eliminar padding del contenedor principal */
        .container-fluid {
            padding: 0 !important;
        }
        
        /* Asegurar que los cards tengan margen pero no padding externo */
        .card {
            font-size: 0.85rem;
            margin-left: 0.5rem;
            margin-right: 0.5rem;
        }
        
        /* Tabla de antecedentes ocupa todo el ancho */
        .tabla-antecedentes-card {
            margin: 0 !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            width: 100% !important;
        }
        
        .tabla-antecedentes-card .card-body {
            padding: 0 !important;
        }
        
        .tabla-antecedentes-card .card-footer {
            padding: 0.5rem;
        }
        
        .table {
            font-size: 0.8rem;
        }
        
        .table td, .table th {
            padding: 0.5rem;
            white-space: nowrap;
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        /* Hacer la tabla scrolleable horizontalmente */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Ajustar iconos */
        .fas, .far {
            font-size: 0.85rem;
        }
        
        h6 {
            font-size: 0.875rem;
        }
        
        /* Badge más pequeño */
        .badge {
            font-size: 0.7rem;
            padding: 0.25em 0.5em;
        }
    }
    
    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    /* Mejorar el espaciado en móvil */
    @media (max-width: 575px) {
        .card-body {
            padding: 0.75rem;
        }
        
        .mb-3 {
            margin-bottom: 0.75rem !important;
        }
        
        .gap-2 {
            gap: 0.5rem !important;
        }
        
        /* Botón de acción más pequeño en móvil */
        .btn-outline-primary {
            padding: 0.2rem 0.4rem;
        }
    }
    
    /* Ajustes adicionales para pantallas muy pequeñas */
    @media (max-width: 375px) {
        .table td, .table th {
            padding: 0.4rem 0.3rem;
            font-size: 0.75rem;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('antecedentsFilterForm');
    const tablaContainer = document.getElementById('tablaAntecedentes');
    const paginacionContainer = document.getElementById('paginacionAntecedentes');
    const busquedaInput = form.querySelector('input[name="busqueda"]');
    
    let debounceTimer;
    
    busquedaInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(realizarBusqueda, 250);
    });
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        realizarBusqueda();
    });
    
    function realizarBusqueda() {
        const params = new URLSearchParams(new FormData(form));
        
        fetch(`{{ request.path }}?${params.toString()}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            tablaContainer.innerHTML = data.tabla;
            paginacionContainer.innerHTML = data.paginacion;
            
            // Reattach event listeners to pagination links
            paginacionContainer.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const url = this.getAttribute('href');
                    fetch(url, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        tablaContainer.innerHTML = data.tabla;
                        paginacionContainer.innerHTML = data.paginacion;
                        window.scrollTo({top: 0, behavior: 'smooth'});
                    });
                });
            });
        })
        .catch(error => console.error('Error:', error));
    }
});
</script>
{% endblock %}