{% extends 'base/base.html' %}

{% block title %}{{ titulo }} - Fisioterapia Clinic{% endblock %}

{% block page_title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        {% if accion == 'crear' %}
                            <i class="fas fa-user-plus"></i> Registrar Nuevo Paciente
                        {% else %}
                            <i class="fas fa-user-edit"></i> Editar Paciente
                        {% endif %}
                    </h5>
                </div>

                <div class="card-body">
                    <form method="post" novalidate>
                        {% csrf_token %}

                        {% if form.non_field_errors %}
                    {% block extra_js %}
                    <script>
                        (function() {
                            function calcAge(dobStr) {
                                if (!dobStr) return '';
                                const dob = new Date(dobStr);
                                if (isNaN(dob)) return '';
                                const today = new Date();
                                let age = today.getFullYear() - dob.getFullYear();
                                const m = today.getMonth() - dob.getMonth();
                                if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;
                                if (age < 0 || age > 120) return '';
                                return age;
                            }

                            const dobInput = document.getElementById('id_fecha_nacimiento');
                            const ageInput = document.getElementById('id_edad');
                            if (!dobInput || !ageInput) return;

                            const updateAge = () => {
                                const age = calcAge(dobInput.value);
                                if (age === '') return; // no actualizar si inválido
                                ageInput.value = age;
                            };

                            // Inicializar al cargar si hay valor existente
                            updateAge();
                            // Actualizar cuando cambie la fecha
                            dobInput.addEventListener('change', updateAge);
                            dobInput.addEventListener('input', updateAge);
                        })();
                    </script>
                    {% endblock %}
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <strong>Error:</strong>
                                {% for error in form.non_field_errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endif %}

                        <!-- Información Personal -->
                        <h6 class="mb-3 mt-3 border-bottom pb-2">
                            <i class="fas fa-id-card"></i> Información Personal
                        </h6>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.nombres.label }}</label>
                                {{ form.nombres }}
                                {% if form.nombres.errors %}
                                    <div class="invalid-feedback d-block">{{ form.nombres.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.apellidos.label }}</label>
                                {{ form.apellidos }}
                                {% if form.apellidos.errors %}
                                    <div class="invalid-feedback d-block">{{ form.apellidos.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">{{ form.fecha_nacimiento.label }}</label>
                                {{ form.fecha_nacimiento }}
                                {% if form.fecha_nacimiento.errors %}
                                    <div class="invalid-feedback d-block">{{ form.fecha_nacimiento.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-4 mb-3">
                                <label class="form-label">{{ form.edad.label }}</label>
                                {{ form.edad }}
                                {% if form.edad.errors %}
                                    <div class="invalid-feedback d-block">{{ form.edad.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-4 mb-3">
                                <label class="form-label">{{ form.genero.label }}</label>
                                {{ form.genero }}
                                {% if form.genero.errors %}
                                    <div class="invalid-feedback d-block">{{ form.genero.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Contacto -->
                        <h6 class="mb-3 mt-4 border-bottom pb-2">
                            <i class="fas fa-phone"></i> Contacto
                        </h6>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.telefono.label }}</label>
                                {{ form.telefono }}
                                {% if form.telefono.errors %}
                                    <div class="invalid-feedback d-block">{{ form.telefono.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.telefono_emergencia.label }}</label>
                                {{ form.telefono_emergencia }}
                                {% if form.telefono_emergencia.errors %}
                                    <div class="invalid-feedback d-block">{{ form.telefono_emergencia.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Domicilio -->
                        <h6 class="mb-3 mt-4 border-bottom pb-2">
                            <i class="fas fa-map-marker-alt"></i> Domicilio
                        </h6>

                        <div class="mb-3">
                            <label class="form-label">{{ form.domicilio.label }}</label>
                            {{ form.domicilio }}
                            {% if form.domicilio.errors %}
                                <div class="invalid-feedback d-block">{{ form.domicilio.errors.0 }}</div>
                            {% endif %}
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle"></i>
                                Ingrese la dirección completa del paciente
                            </small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">{{ form.ocupacion.label }}</label>
                            {{ form.ocupacion }}
                            {% if form.ocupacion.errors %}
                                <div class="invalid-feedback d-block">{{ form.ocupacion.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- Información Médica -->
                        <h6 class="mb-3 mt-4 border-bottom pb-2">
                            <i class="fas fa-heartbeat"></i> Información Médica
                        </h6>

                        <div class="mb-3">
                            <label class="form-label">{{ form.alergias.label }}</label>
                            {{ form.alergias }}
                            {% if form.alergias.errors %}
                                <div class="invalid-feedback d-block">{{ form.alergias.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label class="form-label">{{ form.grupo_sanguineo.label }}</label>
                            {{ form.grupo_sanguineo }}
                            {% if form.grupo_sanguineo.errors %}
                                <div class="invalid-feedback d-block">{{ form.grupo_sanguineo.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label class="form-label">{{ form.religion.label }}</label>
                            {{ form.religion }}
                            {% if form.religion.errors %}
                                <div class="invalid-feedback d-block">{{ form.religion.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- Tipo de Paciente -->
                        <h6 class="mb-3 mt-4 border-bottom pb-2">
                            <i class="fas fa-list"></i> Clasificación
                        </h6>

                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label class="form-label">{{ form.tipo_paciente.label }}</label>
                                {{ form.tipo_paciente }}
                                {% if form.tipo_paciente.errors %}
                                    <div class="invalid-feedback d-block">{{ form.tipo_paciente.errors.0 }}</div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    Seleccione el tipo de paciente según el servicio solicitado
                                </small>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label class="form-label">{{ form.es_frecuente.label }}</label>
                                <div class="form-check form-switch mt-2">
                                    {{ form.es_frecuente }}
                                </div>
                                {% if form.es_frecuente.errors %}
                                    <div class="invalid-feedback d-block">{{ form.es_frecuente.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Botones -->
                        <div class="row mt-4">
                            <div class="col-12 d-flex gap-2 justify-content-end">
                                <a href="{% url 'pacientes:lista' %}" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Cancelar
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    {% if accion == 'crear' %}
                                        <i class="fas fa-save"></i> Registrar Paciente
                                    {% else %}
                                        <i class="fas fa-save"></i> Guardar Cambios
                                    {% endif %}
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .form-control, .form-select {
        border-radius: 5px;
        border: 2px solid #e0e0e0;
        padding: 10px 15px;
        transition: border-color 0.3s;
    }

    .form-control:focus, .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }

    .invalid-feedback {
        color: #dc3545;
        font-size: 13px;
        margin-top: 5px;
    }

    h6 {
        color: #333;
        font-weight: 600;
    }
</style>
{% endblock %}
