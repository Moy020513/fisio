{% extends 'base/base.html' %}

{% block title %}Pacientes - Fisioterapia Clinic{% endblock %}

{% block page_title %}Gestión de Pacientes{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Encabezado con búsqueda -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <form method="get" id="pacienteFiltros" class="form-inline d-flex gap-2" autocomplete="off">
                        <input type="text" name="busqueda" class="form-control flex-grow-1" 
                               placeholder="Buscar por nombre o teléfono..." value="{{ busqueda }}">
                        <select name="tipo" class="form-select" style="max-width: 200px;">
                            <option value="">Todos los tipos</option>
                            <option value="consulta_unica" {% if tipo_filtro == 'consulta_unica' %}selected{% endif %}>Consulta Única</option>
                            <option value="patologia" {% if tipo_filtro == 'patologia' %}selected{% endif %}>Patología</option>
                            <option value="estetico" {% if tipo_filtro == 'estetico' %}selected{% endif %}>Estético</option>
                            <option value="estetico_facial" {% if tipo_filtro == 'estetico_facial' %}selected{% endif %}>Estético Facial</option>
                        </select>
                    </form>
                </div>
                <div class="col-md-4 text-end">
                    <a href="{% url 'pacientes:crear' %}" class="btn btn-success">
                        <i class="fas fa-plus"></i> Nuevo Paciente
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Total Pacientes</h6>
                    <h3 class="mb-0">{{ total_pacientes }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Resultados Encontrados</h6>
                    <h3 class="mb-0" id="resultadosEncontrados">{{ page_obj.paginator.count }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de pacientes -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="fas fa-users"></i> Lista de Pacientes</h5>
        </div>
        <div class="card-body p-0" id="tablaPacientes">
            {% include 'pacientes/partials/_paciente_table.html' %}
        </div>
        <div id="paginacionPacientes">
            {% include 'pacientes/partials/_paciente_pagination.html' %}
        </div>
    </div>
</div>

<style>
    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
    }

    .btn-group-sm {
        gap: 5px;
    }
</style>
{% block extra_js %}
<script>
    (function() {
        const form = document.getElementById('pacienteFiltros');
        if (!form) return;
        const input = form.querySelector('input[name="busqueda"]');
        const tipo = form.querySelector('select[name="tipo"]');
        const tabla = document.getElementById('tablaPacientes');
        const paginacion = document.getElementById('paginacionPacientes');
        const resultados = document.getElementById('resultadosEncontrados');
        let timer;

        const buildUrl = () => {
            const params = new URLSearchParams(new FormData(form));
            return `${window.location.pathname}?${params.toString()}`;
        };

        const fetchData = () => {
            const url = buildUrl();
            fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(resp => resp.json())
                .then(data => {
                    if (tabla && data.table) tabla.innerHTML = data.table;
                    if (paginacion && data.pagination) paginacion.innerHTML = data.pagination;
                    if (resultados && typeof data.resultados !== 'undefined') resultados.textContent = data.resultados;
                    attachPaginationLinks();
                })
                .catch(() => {/* silencioso */});
        };

        const debounceFetch = () => {
            clearTimeout(timer);
            timer = setTimeout(fetchData, 250);
        };

        const attachPaginationLinks = () => {
            if (!paginacion) return;
            paginacion.querySelectorAll('a.page-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const url = this.getAttribute('href');
                    if (!url) return;
                    fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                        .then(resp => resp.json())
                        .then(data => {
                            if (tabla && data.table) tabla.innerHTML = data.table;
                            if (paginacion && data.pagination) paginacion.innerHTML = data.pagination;
                            if (resultados && typeof data.resultados !== 'undefined') resultados.textContent = data.resultados;
                            attachPaginationLinks();
                        })
                        .catch(() => {/* silencioso */});
                });
            });
        };

        if (input) input.addEventListener('input', debounceFetch);
        if (tipo) tipo.addEventListener('change', fetchData);
        attachPaginationLinks();
    })();
</script>
{% endblock %}
{% endblock %}
